# DRF를 이용한 단일데이터 CRUD

## 흐름
- ### db에서 쿼리써서 데이터긁어온다음 시리얼라이저에 넣고 반환값을 응답객체에 넣어서 리턴.


## rest api
 - GET, /articles/ : 게시글 전체 조회
 - POST, /articles/ : 게시글 생성  
     - 게시글 생성은 그냥 리스트 url에 post해도 됨.
     - 참고로, 댓글은 안됨. 왜냐하면 url에 게시글 pk가 들어가야 하므로 (variable routing써야하므로)
 - GET, /articles/<int:article_pk> : 상세조회
 - DELETLE, /articles/<int:article_pk> : 게시글삭제
 - PUT, /articles/<int:article_pk> : 게시글수정

 ## 1. 모델지정, serializer생성
 - serializers.py 에서
 ```python
    from rest_framework import serializers
    from .models import Article


    class ArticleListSerializer(serializers.ModelSerializer):
        class Meta:
            model = Article
            fields = ('id', 'title', 'content')
 ```

 ## 2. 미들웨어 처리 로직
  - ### raise_exception = True
     - 유효성 검사 실패시 400 상태 코드 반환. 
     - 실패시 로직을 따로 작성할 필요 X 
  - ### many = True
    - 여러 인스턴스 넣어도 여러개 한번에 직렬화 가능하도록 하는 옵션

 ```python
from django.shortcuts import render
from rest_framework.decorators import api_view
from rest_framework import status
from rest_framework.response import Response

from .models import Article
from .serializers import ArticleListSerializer

# Create your views here.
@api_view(['GET', 'POST'])
def article_list(request):
    if request.method == 'GET':
        articles = Article.objects.all()
        serializer = ArticleListSerializer(articles, many=True)
        return Response(serializer.data)
    elif request.method == 'POST':
        serializer = ArticleListSerializer(data = request.data)
        if serializer.is_valid(raise_exception=True):
            # raise_exception = True // 유효성 검사 실패시 400상태코드 반환.
            serializer.save()
            return Response( status =status.HTTP_201_CREATED )


@api_view(['GET', 'DELETE', 'PUT'])
def article_detail(request, article_pk):
    article = Article.objects.get(pk=article_pk)

    if request.method == 'GET':
        serializer = ArticleListSerializer(article)
        return Response(serializer.data)
    
    elif request.method == 'DELETE':
        article.delete()
        return Response(status = status.HTTP_204_NO_CONTENT)
    
    elif request.method == 'PUT':
        serializer = ArticleListSerializer(article, data=request.data)
        if serializer.is_valid(raise_exception=True):
            serializer.save()
            return Response(serializer.data)
        
 ```

# DRF 를 이용한 1:N 데이터 CRUD [게시글과 댓글]

## REST API
- GET, 'articles/' : 댓글 전체 조회
- POST, 'articles/<int:article_pk>/comments/' : 댓글 생성
    - 게시글때와 달리, 댓글목록 url에 + POST가 아님.
    - 왜냐면, 어떤 게시글에 달린 댓글인지 url에서 article_pk를 이용해서 나타내기 때문에
- GET, 'comments/<int:comment_pk>/' : 댓글 상세 조회


## 1. serializers.py 에서 
### 댓글 생성시 read_only_fields 이용해서 게시글 유효성검사 통과시키기.
- 모델폼에서 exclude와 비슷한 역할인듯.
- 모델폼에서 exclude를 써서 해당 필드를 입력받지 않도록 만듬.
- 시리얼라이즈를 쓸때도, 클라이언트에서 article 필드는 입력받지 않겠지 당연히?. 그럼 직렬화한 인스턴스에도 article필드 항목이 비어있게되고, 유효성 검사 통과 못함.
- 이때 readonly를 통해 해결 가능.

###  read_only_fields 

- 데이터를 직렬화 할때만 사용한다.즉, 이미 db에 저장된거 꺼내서 앞단으로 보낼때만 취급한다이말임.
- 입력받은것을 db에 넣는과정(이것을 역직렬화라고 하는 것 같다)에서는 취급하지 않음.
- 직렬화 = db에서 꺼내서 앞단으로 보낼때, json형식으로 만드는거
- 역직렬화 = 앞단으로부터 넘겨받은 json파일을 db에저장할때 json형식으로부터 정보들을 풀어내는것.(?)


```python
class CommentSerializer(serializers.ModelSerializer):
    class Meta:
        model = Comment
        fields = '__all__'
        read_only_fields = ('article',)
```

## 2. views.py 는 별거 없음.

```python
@api_view(['GET'])
def comment_list(request):
    if request.method == 'GET':
        comments = Comment.objects.all()
        serializers = CommentSerializer(comments, many = True)
        return Response(serializers.data)

    elif request.method == 'POST':
        pass

@api_view(['GET'])
def comment_detail(request, comment_pk):
    if request.method == 'GET':
        comment =Comment.objects.get(pk=comment_pk)
        serializers = CommentSerializer(comment)
        return Response(serializers.data)

@api_view(['POST'])
def comment_create(request, article_pk):
    article = Article.objects.get(pk=article_pk)
    serializers = CommentSerializer(data = request.data)
    if serializers.is_valid(raise_exception=True):
        serializers.save(article = article)
        return Response(serializers.data, status = status.HTTP_201_CREATED)
    
```

# N:1 역참조하기 [게시글 상세조회시 그 게시글에 달린 댓글까지 전부 가져오기 + 댓글갯수 까지]


## serializers.py에서
### comment_set 필드 추가
 
