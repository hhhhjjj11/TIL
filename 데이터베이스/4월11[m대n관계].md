# 데이터모델링 -> 잘 생각하고 시작해야 편합니다. 

다음의 경우를 생각해보자.
환자와 의사의 데이터를 만들고 싶다.
의사한명이 여러명의 환자를 진료하니까, 
N:1로하면 맞을까? 이는 틀리다.
환자 한명이 여러 의사에게 진료를 받을 수도 있기 때문이다.

이런 경우가 N:M 관계이다.

이럴 경우 어떻게 데이터를 연결지어야할까?

patient의 doctor필드에 여러명의 닥터를 저장하면 되지않나? -> 정규화에 위배된다.

이 경우 "중개 모델"을 새롭게 지정하여 이용한다. 쉽게말해, 예약장부를 따로 판다는 것임.

  1. models.py 에서
```python
from django.db import models

# Create your models here.
class Doctor(models.Model):
    name = models.TextField()

    def __str__(self):
        return f"{self.name} 전문의"
    
class Patient(models.Model):
    name =models.TextField()

    def __str__(self):
        return f"{self.pk}번 환자 {self.name}"
    
class Reservation(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)

    def __str__(self):
        return f'{self.doctor_id}번 의사의 {self.doctor_id}번 환자'
        # doctor 로 foreignkey 잡으면 db에는 doctor_id 언더바 id가 붙어서 들어간다.

```

2. 마이그레이션

3. shell_plus 이용해서 만들어보기
- settings.py에 INSTALLED_APP 에 
'django_extensions' 추가해야 됨을 잊지 말자.
```
$ python manage.py shell_plus
$ doctor1 = Doctor.objects.create(name='elice)
$ patient1 = Patient.objects.create(name='carol')
$ Reservation.objects.create(doctor = doctor1, patient = patient1)
```
- 역참조 각 환자와 의사의 예약 내역 확인햅보기
```
$ doctor1.reservation_set.all()
$ patient1.reservation_set.all()

```


# 중개모델 자동으로 해주기 : ManyToManyField

1. models.py에서

```python
class Patient(models.Model):
    doctors = models.ManyToManyField(Doctor)
    name =models.TextField()

    def __str__(self):
        return f"{self.pk}번 환자 {self.name}"
```

2. 이러고 마이그레이션 하면 중개테이블 만들어져있음

3. shell_plus 키고
- 환자랑 의사 데이터 만든담에
- add 써서 연결시켜줄거임
```
$ patient.doctor.add(doctor1)
-> patient1을 doctor1과 연결

$ patient1.doctors.all()
-> 정참조
-> 환자1과 연결된 모든 의사를 보여줌

```

Q. 역참조?
자. manytomany필드가 patient모델에 들어있다. 그래서 의사에서 


## 예약취소하기 : remove이용
- 환자1번이 의사1에게 예약한 진료를 취소했다면
- shell_plus에서
```
$ doctor1.patients.remove(patient)
또는 
$ patient1.doctors.remoe(doctor1)
```

## 중개모델을 직접 만들어야 하는 경우
- 아이디 뿐만 아니라 다른 정보들도 함께  중개모델에 저장해야 할 경우 ! -> 이경우는 중개모델을 직접 만들어 줘야함
- 왜냐면 매니투매니는 외래키만 들어감
- 예를들어, 환자랑 의사뿐만아니라 예약일, 증상, 등등도 함께 저장하고 싶을경우.

-> 그럼 MTM안쓰고 해야하냐? 노노 MTM에 through옵션을 사용하면 원하는대로 사용 가능.


# MTM에 through옵션 사용하기

```python

class Patient(models.Model):
    doctors = models.ManyToManyField(Doctor, through = 'Reservation', related_name="patients")
    name =models.TextField()

    def __str__(self):
        return f"{self.pk}번 환자 {self.name}"
    

class Reservation(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
    symptoms = models.TextField()
    reserved_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f'{self.doctor_id}번 의사의 {self.patient_id}번 환자'
        # doctor 로 foreignkey 잡으면 db에는 doctor_id 언더바 id가 붙어서 들어간다.

```


## 자, 우리는 이제 모델끼리 연결짓고, 그다음에 중개테이블에 추가적으로 정보까지 적어넣을수 있게 되었다. 
모델끼리 연결짓는 방법은 add를 이용했었다.
그렇다면 증상이나 예약날짜 등과같은 모델이 아닌 필드를 중개테이블에 저장해넣고싶을때는 어떻게 할까? =>through_defaults={'v필드명' : '값'} 을 이용한다.

- shell_plus 에서
```
$ patient2.doctors.add(doctor1, through_defaults={'symptoms': 'flu'})
```




## MTM의 또다른 옵션 : symmetrical
- A랑 B가 있을때, A가 B를 추가하면 B에도 A를 자동으로 추가해주도록 설정
- True값이 디폴트임
- 그러면 언제 false로 설정해서 쓰느냐???
-예를들어 팔로우 거는거 생각해보자. N:M관계이지만 한쪽만 일방적으로 걸고 대칭이 아님 
