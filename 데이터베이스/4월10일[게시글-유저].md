# 댓글 스키마에 유저필드 추가하기(어떤 유저가 만든 댓글인지 연결시키는것)

1. 스키마에 추가 (게시글과 똑같음)
```python

class Comment(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL , on_delete=models.CASCADE)
    article = models.ForeignKey(Article, on_delete=models.CASCADE)
    content = models.CharField(max_length=200)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.content

```

2. 마이그레이션

3. 폼에서 사용자가 user 지정 못하도록(안보이도록) 해주기 
```python
class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        # fields = '__all__'
        exclude = ('article', 'user',)
```

4. views.py에서 db에 넣기전에 user필드를 직접지정해주어야한다. 사용자는 user필드를 입력한 적이 없다. exclude를 이용해서 사용자가 몇가지 필드들을 고를 수 없게 했었다. 그런데 NULL값이 허용되지 않는 필드이면 db에 저장이 안되고 에러난다. 따라서 exclude처리한 필드들을 미들웨어에서 직접 지정해주어야한다.
댓글의 경우 1.게시글 2. 유저 이렇게 두 개를 직접 지정 해주어야 한다.

```python
def comments_create(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm(request.POST)
    if comment_form.is_valid():
        comment = comment_form.save(commit=False)
        comment.article = article
        comment.user= request.user
        comment.save()
    return redirect('articles:detail', article.pk)
```

# 댓글목록에 작성자 출력

1. 템플릿에서 표시하고싶은곳에 {{comment.user}} 넣어주면 끝.


# 로그인권한 : 작성자만 댓글 지울 수 있도록 하기
- 핵심아이디어 : 작성자랑 로그인한 사용자랑 같을 때만 삭제되도록 만들어주면 됨.

1. views.py에서
```python

def comments_delete(request, pk, comment_pk):
    comment = Comment.objects.get(pk=comment_pk)
    if request.user == comment.user:
        comment.delete()
    return redirect('articles:detail', pk)

```

2. 템플릿에서 (자기가쓴댓글일때만 삭제버튼보이게 하기)
```python

```



# 인증된 사용자인 경우만 댓글 작성 및 삭제하기

-> 미들웨어에서 if request.user.is_authenticated:
문 추가.

```python
def comments_create(request, pk):
    if request.user.is_authenticated:
        article = Article.objects.get(pk=pk)
        comment_form = CommentForm(request.POST)
        if comment_form.is_valid():
            comment = comment_form.save(commit=False)
            comment.article = article
            comment.user= request.user
            comment.save()
        return redirect('articles:detail', article.pk)
    return redirect('accounts:login')
```

# 로그인한 유저에게만 댓글 폼 보이도록 하기
1. 템플릿에서 
{
```

```